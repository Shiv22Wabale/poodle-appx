<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="theme-color" content="#000000" />
  <title>{{{title}}}</title>
  <script type="module" src="/dist/lib/main.js"></script>
</head>

<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>
</body>

<script type="module">

  let hasRegStep = false;

  (function() {
    "use strict"

    if (!navigator.serviceWorker || !navigator.serviceWorker.register) {
      document.getElementById('root').value = `
          This browser is not supported!
          Use a latest version of Chrome, Edge, Safari, or Firefox to view this site.
      `
      return
    }

    if (!navigator.serviceWorker.controller) {
      hasRegStep = true
      // register service worker
      navigator.serviceWorker.register('/sw.js', {scope: '/'})
      .then((reg) => {
        // registration successful
        console.log('Service Worker: registration succeeded. Scope is ' + reg.scope)
        //console.log(reg)
        navigator.serviceWorker.ready.then(regActive => {
          console.log('Service Worker: ready')
          //console.log(navigator.serviceWorker)
          //console.log(reg)
          console.log(regActive.active)
          //reg.active.onstatechange = e => {
          //  console.log(e)
          //}
          // Listen to messages from service workers.
          regActive.active.addEventListener('message', function(event) {
              console.log("Got reply from service worker: " + event.data)
          })
        })
      }).catch((error) => {
        // registration failed
        console.log('Service Worker: registration failed - ' + error)
      })
    }

    //if (navigator.serviceWorker.controller) {
    //  // Yes, send our controller a message.
    //  console.log("Sending 'hi' to controller");
    //  navigator.serviceWorker.controller.postMessage({
    //    type: 'importMaps',
    //    baseurl: 'http://localhost:3000',
    //    importMaps: {
    //      imports: {
    //        "app-x/": "http://localhost:3001/app-x/",
    //        "self/": "http://localhost:3001/ui/sys/appx/base/current"
    //      }
    //    }
    //  })
    //}
  })()

  import { default as lib } from "/dist/lib/main.js"

  // render function
  async function render() {

    import('/app-x/AppX').then(appx => {
      const AppX = appx.default
      //console.log(App)
      lib['react-dom'].render(
          lib['react'].createElement(AppX, null),
          document.getElementById('root')
      )
    })
  }

  // wait for service worker registration, or render immediately
  if (hasRegStep) {
    setTimeout(render, 1500)
  } else {
    render()
  }

</script>
</html>
